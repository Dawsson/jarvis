# Automatic PR Creation Flow

## Overview

When you create a coding session with a worktree, Jarvis will automatically create a pull request when the session completes successfully.

## How It Works

### 1. Repository Discovery
- Repositories are discovered from `~/projects/` folder
- Each subfolder with a `.git` directory is treated as a repository
- Repository list is saved to `.memory/jarvis-memory.json`

### 2. Session Creation via Voice

**Example voice command:**
```
"Jarvis, create a coding session to add authentication to Cookify"
```

**What happens:**
- Jarvis resolves "Cookify" to the repository at `~/projects/cookify`
- Creates a new git worktree branch (e.g., `jarvis/add-authentication-123456`)
- Starts a Claude Agent SDK session in the worktree directory
- Session runs in the background asynchronously

### 3. Session Execution
- Claude Agent SDK processes the task autonomously
- Makes code changes, creates/modifies files
- All activity is logged to `.memory/claude-sessions/<session-id>.jsonl`
- Session metadata saved to `.memory/claude-sessions/<session-id>.meta.json`

### 4. Automatic PR Creation

When the session completes successfully **and used a worktree**, Jarvis automatically:

1. **Commits changes:**
   ```bash
   git add -A
   git commit -m "<task description>

   ðŸ¤– Completed by Jarvis
   Session: <session-id>"
   ```

2. **Pushes to remote:**
   ```bash
   git push -u origin <branch-name>
   ```

3. **Creates PR using gh CLI:**
   ```bash
   gh pr create --base main --title "<PR title>" --body "<PR body>"
   ```

4. **Saves PR URL to session metadata:**
   - `jarvis_metadata.pr_url` contains the GitHub PR URL
   - Accessible via `getClaudeSessionStatus` tool

### PR Title & Body Format

**Title:** Auto-generated from task (capitalized, limited to 72 chars)
- Example: `Add authentication to Cookify`

**Body:**
```markdown
## Summary

Add authentication to Cookify

## Changes

**Files created:**
- src/auth/login.ts
- src/auth/middleware.ts

**Files modified:**
- src/index.ts
- package.json

---

ðŸ¤– Generated by [Jarvis](https://github.com/yourusername/jarvis)
Session ID: jarvis-1234567890-abcd1234
```

## Voice Commands

### Create a session (no PR)
```
"Jarvis, create a coding session to fix the bug in the login flow"
```
â†’ Runs in current repo directory, no worktree, no PR

### Create a session with automatic PR
```
"Jarvis, create a coding session with worktree to add dark mode support"
```
â†’ Creates worktree, completes work, automatically creates PR

### Check session status
```
"Jarvis, what's the status of my coding session?"
```
â†’ Returns status, files changed, and PR URL if created

### List all sessions
```
"Jarvis, list all coding sessions"
```
â†’ Shows all sessions with status

## Tool Parameters

### `createClaudeSession`
```typescript
{
  task: string;                    // Required: What to build
  repositoryName?: string;         // Optional: Which repo (defaults to current project)
  useWorktree?: boolean;          // Optional: Create isolated worktree (enables auto-PR)
  worktreeName?: string;          // Optional: Custom branch name
  cwd?: string;                   // Optional: Working directory override
}
```

### Example tool calls from Jarvis:
```javascript
// Simple session - no PR
createClaudeSession({
  task: "Refactor the authentication system"
})

// Session with auto-PR
createClaudeSession({
  task: "Add dark mode support",
  useWorktree: true
})

// Session in specific repo with auto-PR
createClaudeSession({
  task: "Add caching layer",
  repositoryName: "cookify",
  useWorktree: true
})
```

## Requirements

- **gh CLI** must be installed and authenticated
  ```bash
  gh auth login
  ```

- Repository must have a remote configured
  ```bash
  git remote -v
  ```

- Repository must not be on the default branch when creating worktree

## Session Storage

All sessions are stored locally in `.memory/claude-sessions/`:

```
.memory/
â””â”€â”€ claude-sessions/
    â”œâ”€â”€ jarvis-1234567890-abcd1234.jsonl      # Full event log
    â””â”€â”€ jarvis-1234567890-abcd1234.meta.json  # Metadata
```

### Metadata includes:
- `session_id`: Unique identifier
- `repository_name`: Which repo was used
- `repository_path`: Full path to repo
- `worktree_path`: Path to worktree (if used)
- `files_created`: Array of created files
- `files_modified`: Array of modified files
- `jarvis_metadata.pr_url`: GitHub PR URL (if created)
- `status`: 'active' | 'completed' | 'error'

## Worktree Management

Worktrees are created in `~/projects/jarvis-worktrees/`:

```
~/projects/
â”œâ”€â”€ jarvis/
â”œâ”€â”€ cookify/
â””â”€â”€ jarvis-worktrees/
    â”œâ”€â”€ add-authentication-123456/
    â”œâ”€â”€ add-dark-mode-789012/
    â””â”€â”€ fix-bug-345678/
```

Each worktree is an isolated git working directory with its own branch.

## Benefits

1. **Non-blocking**: Sessions run in the background while you do other things
2. **Isolated**: Worktrees keep changes separate from main branch
3. **Automatic**: PR creation happens without manual intervention
4. **Trackable**: Full session history in JSONL format
5. **Voice-controlled**: Start sessions hands-free via Jarvis

## Example Flow

```
User: "Jarvis, create a coding session to add user profiles to Cookify with a worktree"

Jarvis: "I've started the coding session, Sir. Working on: add user profiles to Cookify"

[10-30 seconds later...]

Jarvis: "The coding session has completed, Sir. Created 3 files and modified 2 files.
         A pull request has been created: https://github.com/you/cookify/pull/42"

User: "Jarvis, open that PR in my browser"

Jarvis: [Opens PR URL]
```

## Troubleshooting

### PR not created
- Check gh CLI: `gh auth status`
- Ensure worktree was used: Check session metadata for `worktree_path`
- Check logs: `.memory/claude-sessions/<session-id>.jsonl`

### Session stuck
- Check status: "Jarvis, what's the status of my coding session?"
- View logs: `cat .memory/claude-sessions/*.meta.json | grep status`

### Wrong repository
- Verify current project: Check `.memory/jarvis-memory.json` -> `currentProjectId`
- Specify explicitly: Use `repositoryName` parameter in tool call
